<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Models | DeepNIDS</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/models.css') }}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="layout">

        <!-- ================= SIDEBAR ================= -->
        <div class="sidebar">
            <img class="logo" id="logo" src="/static/images/logo.jpeg" width="200" alt="Security">
            <h2>üîê DeepNIDS</h2>
            <a href="/home">üè† Home</a>
            <a href="/models" class="active">üìä Models</a>
            <a href="/compare">üìà Compare Models</a>
            <a href="/logs">üìú Logs</a>
            <a href="/about">üë• About</a>
            <a href="/contact">üì© Contact</a>
            {% if session.user == "admin" %}
            <a href="/admin/messages">üõ† Admin Messages</a>
            {% endif %}

            <div class="sidebar-bottom">
                <a href="/logout">üö™ Logout</a>
                <button onclick="toggleTheme()">üåì Theme</button>
            </div>
        </div>

        <!-- ================= MAIN CONTENT ================= -->
        <main class="content models-page">

            <!-- PAGE HEADER -->
            <div class="models-header">
                <h1>Intrusion Detection Models</h1>
                <p>Select a model to predict, evaluate, or download report</p>
            </div>

            <!-- ================= MODELS GRID ================= -->
            <div class="models-grid">

                <!-- ================= MODEL CARD TEMPLATE ================= -->
                {% set models = [
                ("DNN", "Deep Neural Network"),
                ("CNN", "Convolutional Neural Network"),
                ("LSTM", "Long Short-Term Memory"),
                ("AUTOENCODER", "Anomaly Detection Autoencoder")
                ] %}

                {% for model, desc in models %}
                <div class="model-card" id="card-{{ model }}">

                    <div class="model-title">
                        <h2>{{ model }}</h2>
                        <span class="model-badge">DL</span>
                    </div>

                    <p class="model-desc">{{ desc }}</p>

                    <div class="model-actions">
                        <button class="btn-predict" onclick="predict('{{ model }}')">
                            Predict
                        </button>

                        <button class="btn-evaluate" onclick="evaluateModel('{{ model }}')">
                            Evaluate
                        </button>

                        <button class="btn-download" onclick="downloadReport('{{ model }}')">
                            Download PDF
                        </button>
                    </div>

                    <div class="result-box" id="result-{{ model }}">
                        Waiting for action...
                    </div>

                    <div class="chart-container">
                        <canvas id="chart-{{ model }}"></canvas>
                    </div>

                </div>
                {% endfor %}
            </div>
        </main>
    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script src="/static/js/theme.js"></script>
    <script>
        /* ================= PREDICT ================= */
        function predict(model) {
            fetch("/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: model })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById(`result-${model}`).innerHTML =
                        `<b>Prediction:</b> ${data.prediction}<br>
             <b>Confidence:</b> ${data.confidence}`;
                })
                .catch(() => {
                    document.getElementById(`result-${model}`).innerHTML =
                        "Prediction failed";
                });
        }

        /* ================= EVALUATE ================= */
        function evaluateModel(model) {
            fetch("/evaluate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: model })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById(`result-${model}`).innerHTML =
                        `<b>Accuracy:</b> ${data.accuracy}<br>
             <b>Precision:</b> ${data.precision}<br>
             <b>Recall:</b> ${data.recall}<br>
             <b>F1-Score:</b> ${data.f1_score}`;

                    drawChart(model, data.confusion_matrix);
                })
                .catch(() => {
                    document.getElementById(`result-${model}`).innerHTML =
                        "Evaluation failed";
                });
        }

        /* ================= CONFUSION MATRIX CHART ================= */
        function drawChart(model, cm) {
            const ctx = document.getElementById(`chart-${model}`).getContext("2d");

            if (window[`chart_${model}`]) {
                window[`chart_${model}`].destroy();
            }

            window[`chart_${model}`] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["TN", "FP", "FN", "TP"],
                    datasets: [{
                        label: "Confusion Matrix",
                        data: [cm[0][0], cm[0][1], cm[1][0], cm[1][1]],
                        backgroundColor: [
                            "#22c55e",
                            "#ef4444",
                            "#f97316",
                            "#3b82f6"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        /* ================= DOWNLOAD PDF ================= */
        function downloadReport(model) {
            fetch("/download_report", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: model })
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = model + "_evaluation_report.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    // window.URL.revokeObjectURL(url);
                });
        } 
    </script>

</body>

</html>